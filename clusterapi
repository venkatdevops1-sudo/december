*** Settings ***
Library              RequestsLibrary
Library              Collections
Library              JSONLibrary
Library              String
Library              OperatingSystem

*** Variables ***
${splunk_base_url}          https://it-infra-apis.cloud.uk.hsbc/
${splunk_auth_token_pass}   R0TUzDLVqbblN5RT0IMEQ3JTY1MjFEMEZER2I2
${jobId_file}               jobid.txt

*** Keywords ***
Create API Session
    [Documentation]    Create an API session with headers
    ${headers}=    Create Dictionary    Authorization=Basic ${splunk_auth_token_pass}    Content-Type=application/json
    Log To Console    Headers: ${headers}
    Create Session    sessionId    ${splunk_base_url}    headers=${headers}    verify=False

Fetch JobId and Store Globally
    [Documentation]    Fetch jobId and store it globally
    ${params_dict}=    Create Dictionary    targetNode=CAW25038829N03    action=listresources
    Log To Console    Request Body: ${params_dict}

    ${response}=    POST On Session    sessionId    /cto-pa-win-clus-mgmt/api/v1/details    json=${params_dict}    expected_status=200
    Log To Console    Response Received: ${response.json()}

    ${jobId}=    Get Value From Json    ${response.json()}    jobId
    Log To Console    Retrieved jobId: ${jobId}

    Set Suite Variable    ${jobId}
    Log To Console    Stored jobId Globally: ${jobId}

Write JobId to File
    [Documentation]    Write the jobId to a file
    ${jobId_str}=    Convert To String    ${jobId}
    Create File    ${jobId_file}    ${jobId_str}
    Log To Console    jobId written to file successfully: ${jobId_str}

Fetch Details Using JobId
    [Documentation]    Fetch details using the jobId from the file
    ${jobId}=    Get File    ${jobId_file}
    Log To Console    Retrieved jobId from file: ${jobId}

    ${url}=    Catenate    SEPARATOR=/    /cto-pa-win-clus-mgmt/api/v1/details    ${jobId}
    Log To Console    URL Constructed: ${url}

    ${headers}=    Create Dictionary    Authorization=Basic ${splunk_auth_token_pass}    Content-Type=application/json
    ${response}=    GET On Session    sessionId    ${url}    expected_status=200
    Log To Console    Response Received: ${response.json()}

    Should Not Be Empty    ${response.json()}    Response should not be empty
    Log To Console    Details retrieved successfully.

*** Test Cases ***
Fetch and Validate JobId Test
    [Documentation]    Fetch jobId and validate it
    Create API Session
    Fetch JobId and Store Globally
    Write JobId to File

Fetch Details Using JobId Test
    [Documentation]    Use jobId to fetch details
    Fetch Details Using JobId

*** Settings ***
Library              RequestsLibrary
Library              Collections
Library              JSONLibrary
Library              String

*** Variables ***
${cluster_base_url}       https://it-infra-apis.cloud.uk.hsbc/
${cluster_auth_token_pass}    R0ItU1ZDLVdpblNSRTo1MEQ3LTY1MjFEMEZERA==

*** Keywords ***
Cluster API Call
    [Documentation]    Call Cluster API to fetch jobId
    Log To Console    ---- Starting Cluster API Call ----
    Log To Console    Creating Headers for API Request
    ${headers}=    Create Dictionary    Authorization=Basic ${cluster_auth_token_pass}    Content-Type=application/json
    Log To Console    Headers Created: ${headers}

    Log To Console    Creating API Session
    Create Session    sessionId    ${cluster_base_url}    headers=${headers}    verify=False
    Log To Console    API Session Created Successfully

    Log To Console    Creating Request Payload
    ${params_dict}=    Create Dictionary    targetNode=CAW25038829N03    action=listresources
    Log To Console    Request Payload: ${params_dict}

    Log To Console    Sending POST Request to API Endpoint: /cto-pa-win-clus-mgmt/api/v1/details
    ${response}=    POST On Session    sessionId    /cto-pa-win-clus-mgmt/api/v1/details    json=${params_dict}    expected_status=any
    Log To Console    Response Status: ${response.status_code}
    Log To Console    Response Body: ${response.text}

    Log To Console    ---- Returning API Response JSON ----
    [Return]    ${response.json()}

Fetch jobId
    [Documentation]    Fetch jobId from API response
    Log To Console    ---- Fetching jobId from API Response ----
    ${response}=    Cluster API Call
    Log To Console    Parsing Response JSON for jobId
    ${jobId}=    Get Value From Json    ${response}    $.jobId
    Log To Console    jobId Successfully Retrieved: ${jobId}
    [Return]    ${jobId}

Fetch File Share Witness
    [Documentation]    Fetch File Share Witness state using jobId
    [Arguments]    ${jobId}
    Log To Console    ---- Fetching File Share Witness for jobId: ${jobId} ----

    Log To Console    Creating Headers for GET Request
    ${headers}=    Create Dictionary    Authorization=Basic ${cluster_auth_token_pass}    Content-Type=application/json
    Log To Console    Headers Created: ${headers}

    Log To Console    Sending GET Request to Endpoint: /cto-pa-win-clus-mgmt/api/v1/details/${jobId}
    ${response}=    GET On Session    sessionId    /cto-pa-win-clus-mgmt/api/v1/details/${jobId}    headers=${headers}    expected_status=any
    Log To Console    Response Status: ${response.status_code}
    Log To Console    Response Body: ${response.text}

    Log To Console    Parsing Response JSON for File Share Witness State
    ${file_share_state}=    Get Value From Json    ${response}    $.taskOutput["File Share Witness"]
    Log To Console    File Share Witness State Retrieved: ${file_share_state}

    Log To Console    ---- Returning File Share Witness State ----
    [Return]    ${file_share_state}

*** Test Cases ***
Fetch jobId Test
    [Documentation]    Test case to fetch jobId
    Log To Console    ---- Starting Test Case: Fetch jobId Test ----
    ${jobId}=    Fetch jobId
    Log To Console    Test Case Completed: jobId Retrieved - ${jobId}

Fetch File Share Witness Test
    [Documentation]    Test case to fetch File Share Witness state
    Log To Console    ---- Starting Test Case: Fetch File Share Witness Test ----
    ${jobId}=    Fetch jobId
    Log To Console    Retrieved jobId: ${jobId}

    ${file_share_state}=    Fetch File Share Witness    ${jobId}
    Log To Console    File Share Witness State: ${file_share_state}

    Log To Console    ---- Test Case Completed: File Share Witness State Retrieved ----
